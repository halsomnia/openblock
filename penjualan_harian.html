<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Laporan Penjualan & Pembayaran</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;700&display=swap" rel="stylesheet">
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

    <style>
        :root {
            --primary-black: #000000;
            --light-gray: #f9f9f9;
            --border-color: #eeeeee;
        }

        body {
            margin: 0;
            font-family: 'DM Sans', sans-serif;
            background: #f4f4f4;
            color: var(--primary-black);
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .container {
            width: 100%;
            max-width: 650px;
            background: #ffffff;
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
            border-radius: 20px;
            overflow: hidden;
            position: relative;
        }

        #capture-area {
            background: #fff;
            padding: 30px;
        }

        .header-title {
            background: var(--primary-black);
            color: #ffffff;
            padding: 40px 30px;
            margin: -30px -30px 30px -30px;
            border-radius: 0 0 20px 20px;
            text-align: center;
        }

        .header-title h1 {
            margin: 0;
            font-size: 1.8em;
            font-weight: 700;
        }

        .filter-group {
            display: flex;
            gap: 15px;
            margin-bottom: 25px;
        }

        .filter-item {
            display: flex;
            flex-direction: column;
            gap: 5px;
            flex: 1;
        }

        select {
            padding: 10px;
            border: 1.5px solid var(--primary-black);
            border-radius: 8px;
            font-family: 'DM Sans', sans-serif;
            font-weight: 500;
            outline: none;
        }

        /* Tabel Utama & Summary Style */
        .table-container, .summary-container {
            width: 100%;
            border-radius: 12px;
            overflow: hidden;
            border: 1px solid var(--border-color);
            margin-bottom: 25px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        thead th {
            background: var(--primary-black);
            color: #ffffff;
            font-size: 0.75em;
            text-transform: uppercase;
            padding: 12px 5px;
            border-right: 1px solid rgba(255,255,255,0.2);
        }

        thead th:last-child { border-right: none; }

        tbody td {
            padding: 12px 8px;
            border-bottom: 1px solid var(--border-color);
            font-size: 0.85em;
        }

        tbody tr:nth-child(even) { background-color: var(--light-gray); }

        .text-right { text-align: right; }
        .text-center { text-align: center; }

        /* Row Hitam untuk Grand Total */
        .black-row td {
            background: var(--primary-black) !important;
            color: #ffffff !important;
            font-weight: 700;
            border-bottom: none;
        }

        .label-gudang {
            font-weight: 500;
            text-align: right;
            padding-right: 15px;
        }

        .btn-action-container {
            display: flex;
            justify-content: center;
            padding: 10px 30px 30px 30px;
        }

        .btn-wa {
            background: #25D366;
            color: #fff;
            border: none;
            padding: 10px 40px;
            border-radius: 30px;
            font-weight: 700;
            font-size: 0.9em;
            cursor: pointer;
        }

        #loader-overlay {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(255,255,255,0.9);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 10;
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid var(--primary-black);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>

    <div class="container">
        <div id="loader-overlay">
            <div class="spinner"></div>
            <p style="margin-top: 15px; font-weight: 500; font-size: 0.8em;">Sinkronisasi Data...</p>
        </div>

        <div id="capture-area">
            <div class="header-title">
                <h1>Penjualan & Pembayaran</h1>
            </div>

            <div class="filter-group">
                <div class="filter-item">
                    <label style="font-size: 0.7em; font-weight: 700; color: #888;">TAHUN</label>
                    <select id="selTahun" onchange="renderLaporan()"></select>
                </div>
                <div class="filter-item">
                    <label style="font-size: 0.7em; font-weight: 700; color: #888;">BULAN</label>
                    <select id="selBulan" onchange="renderLaporan()"></select>
                </div>
            </div>

            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th rowspan="2" class="text-center">Tanggal</th>
                            <th colspan="2" class="text-center">Penjualan</th>
                            <th colspan="2" class="text-center">Pembayaran</th>
                        </tr>
                        <tr>
                            <th class="text-center">Bandung</th>
                            <th class="text-center">Cirebon</th>
                            <th class="text-center">Bandung</th>
                            <th class="text-center">Cirebon</th>
                        </tr>
                    </thead>
                    <tbody id="tableBody"></tbody>
                </table>
            </div>

            <div class="summary-container">
                <table>
                    <thead>
                        <tr>
                            <th class="text-right" style="width: 30%; padding-right: 15px;">Gudang</th>
                            <th class="text-center">Penjualan</th>
                            <th class="text-center">Pembayaran</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td class="label-gudang">Bandung</td>
                            <td id="sumJualBdg" class="text-right">0</td>
                            <td id="sumBayarBdg" class="text-right">0</td>
                        </tr>
                        <tr>
                            <td class="label-gudang">Cirebon</td>
                            <td id="sumJualCrb" class="text-right">0</td>
                            <td id="sumBayarCrb" class="text-right">-</td>
                        </tr>
                        <tr class="black-row">
                            <td class="label-gudang">Grand Total</td>
                            <td id="grandTotalJual" class="text-right">0</td>
                            <td id="grandTotalBayar" class="text-right">0</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <div class="btn-action-container">
            <button class="btn-wa" onclick="kirimWhatsApp()">Kirim</button>
        </div>
    </div>

<script>
    const urlAPI = "https://script.google.com/macros/s/AKfycbzdkDn2wivAYXgo2BsOpF8NTEj7xRqi4xnkI4IVzF5MHMIjzF5N-r0_PaCQLLmOeKQU/exec"; 
    let masterPenjualan = [];
    let masterPembayaran = [];
    const urutanBulan = ["Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"];

    async function init() {
        try {
            const res = await fetch(urlAPI);
            const data = await res.json();
            masterPenjualan = data.penjualan;
            masterPembayaran = data.pembayaran;
            document.getElementById('loader-overlay').style.display = 'none';
            populateFilters();
            renderLaporan();
        } catch (e) { 
            alert("Gagal sinkronisasi data.");
        }
    }

    function populateFilters() {
        const tahunSet = [...new Set(masterPenjualan.map(item => item.Tahun))].sort((a, b) => b - a);
        const bulanUnik = [...new Set(masterPenjualan.map(item => item.Bulan))];
        const bulanSorted = bulanUnik.sort((a, b) => {
            let idxA = urutanBulan.findIndex(m => a.includes(m));
            let idxB = urutanBulan.findIndex(m => b.includes(m));
            return idxA - idxB;
        });

        const selTahun = document.getElementById('selTahun');
        const selBulan = document.getElementById('selBulan');

        selTahun.innerHTML = ""; selBulan.innerHTML = "";
        tahunSet.forEach(t => selTahun.innerHTML += `<option value="${t}">${t}</option>`);
        bulanSorted.forEach(b => selBulan.innerHTML += `<option value="${b}">${b}</option>`);

        // Default ke hari ini
        const now = new Date();
        selTahun.value = now.getFullYear();
        // Mencocokkan bulan filter dengan data (misal "1-24 Dec" mengandung "Dec")
        const currentBulanName = urutanBulan[now.getMonth()];
        const matchedBulan = bulanSorted.find(b => b.includes(currentBulanName));
        if (matchedBulan) selBulan.value = matchedBulan;
    }

    function renderLaporan() {
        const thnSelected = parseInt(document.getElementById('selTahun').value);
        const blnStr = document.getElementById('selBulan').value;
        const tbody = document.getElementById('tableBody');
        
        tbody.innerHTML = "";
        let dataMap = {};
        let sJBdg = 0, sJCrb = 0, sBBdg = 0, sBCrb = 0;

        // Cari bulan index dari string filter (misal "1-24 Dec" -> Dec -> index 11)
        const blnIdx = urutanBulan.findIndex(m => blnStr.includes(m));
        const today = new Date();
        let lastDay;
        
        // Batas tanggal: jika tahun & bulan adalah SEKARANG, batasnya hari ini.
        if (thnSelected === today.getFullYear() && blnIdx === today.getMonth()) {
            lastDay = today.getDate(); 
        } else {
            lastDay = new Date(thnSelected, blnIdx + 1, 0).getDate(); 
        }

        // 1. Siapkan urutan tanggal 1 - hari ini menggunakan TAHUN YANG DIPILIH
        for (let i = 1; i <= lastDay; i++) {
            const dObj = new Date(thnSelected, blnIdx, i);
            const key = dObj.toDateString();
            dataMap[key] = { jBdg: 0, jCrb: 0, bBdg: 0, bCrb: 0 };
        }

        // 2. Masukkan data Penjualan (cocokkan berdasarkan filter Tahun & Bulan)
        masterPenjualan.filter(d => d.Tahun == thnSelected && d.Bulan == blnStr).forEach(row => {
            const tglVal = new Date(row["Tgl Faktur"]).toDateString();
            if (dataMap[tglVal]) {
                const nilai = Math.round(parseFloat(row["Jumlah (Inc)"]) || 0);
                if (row["Gudang"] === "BANDUNG") { dataMap[tglVal].jBdg += nilai; sJBdg += nilai; }
                else { dataMap[tglVal].jCrb += nilai; sJCrb += nilai; }
            }
        });

        // 3. Masukkan data Pembayaran
        masterPembayaran.filter(p => p.Tahun == thnSelected && p.Bulan == blnStr).forEach(row => {
            const tglVal = new Date(row["Tanggal"]).toDateString();
            if (dataMap[tglVal]) {
                const nilai = Math.round(parseFloat(row["Jumlah Bayar"]) || 0);
                if (row["Gudang"] === "BANDUNG") { dataMap[tglVal].bBdg += nilai; sBBdg += nilai; }
                else { dataMap[tglVal].bCrb += nilai; sBCrb += nilai; }
            }
        });

        // 4. Render baris tabel
        Object.keys(dataMap).forEach(key => {
            const d = new Date(key);
            // Gunakan d.getFullYear() agar tahun 2025 tampil sebagai "25"
            const tglFmt = `${d.getDate()}-${urutanBulan[d.getMonth()]}-${d.getFullYear().toString().slice(-2)}`;
            const row = dataMap[key];

            tbody.innerHTML += `<tr>
                <td class="text-center">${tglFmt}</td>
                <td class="text-right">${row.jBdg.toLocaleString('id-ID')}</td>
                <td class="text-right">${row.jCrb.toLocaleString('id-ID')}</td>
                <td class="text-right" style="color:#2e7d32">${row.bBdg.toLocaleString('id-ID')}</td>
                <td class="text-right" style="color:#2e7d32">${row.bCrb.toLocaleString('id-ID')}</td>
            </tr>`;
        });

        // Update Tabel Summary
        document.getElementById('sumJualBdg').innerText = sJBdg.toLocaleString('id-ID');
        document.getElementById('sumBayarBdg').innerText = sBBdg.toLocaleString('id-ID');
        document.getElementById('sumJualCrb').innerText = sJCrb.toLocaleString('id-ID');
        document.getElementById('sumBayarCrb').innerText = sBCrb === 0 ? "-" : sBCrb.toLocaleString('id-ID');
        document.getElementById('grandTotalJual').innerText = (sJBdg + sJCrb).toLocaleString('id-ID');
        document.getElementById('grandTotalBayar').innerText = (sBBdg + sBCrb).toLocaleString('id-ID');
    }

    async function kirimWhatsApp() {
        const area = document.getElementById('capture-area');
        document.getElementById('loader-overlay').style.display = 'flex';
        const canvas = await html2canvas(area, { scale: 2 });
        const imgData = canvas.toDataURL("image/jpeg", 0.9);
        const link = document.createElement('a');
        link.download = `Laporan_Harian.jpg`;
        link.href = imgData;
        link.click();
        document.getElementById('loader-overlay').style.display = 'none';
        setTimeout(() => { window.open(`https://wa.me/?text=Laporan Penjualan & Pembayaran`, '_blank'); }, 500);
    }

    init();
</script>
</body>
</html>
